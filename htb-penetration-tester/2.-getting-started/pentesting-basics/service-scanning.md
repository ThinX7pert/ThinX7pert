# Service Scanning

## Nmap (Network Mapper)

**`Nmap`** is an open source tool for network exploration security and security auditing. It was designed to rapidly scan large networks, although it works fine against single hosts. Nmap uses raw IP packets in novel ways to determine what hosts are available on the network, what services those hosts are offering, what operating systems they are running, what type of packet filters/firewalls are in use, and dozens of other characteristics.

Let us start with the most basic scan. Suppose that we want to perform a basic scan against a target residing at **`10.129.42.253`**. To do this, we should type **`nmap 10.129.42.253`** and hit return. We see that the **Nmap** scan was completed very quickly. This because if we don't specify any additional options, Nmap will only scan the **`1,000`** most common ports by default. The scan output reveals that ports 21, 22, 80, 139, and 445 are available :&#x20;

```shell-session
$ nmap 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:07 EST
Nmap scan report for 10.129.42.253
Host is up (0.11s latency).
Not shown: 995 closed ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

Nmap done: 1 IP address (1 host up) scanned in 2.19 seconds
```

* Under the **`PORT`** heading, it also tells us that these are TCP ports. By default, Nmap will conduct a TCP scan unless specifically requested to perform a UDP scan.
* The **`STATE`** heading confirms that these ports are **`open`**. Sometimes we will see other ports listed that have a different state, such as **filtered**. This can happen if a firewall is only allowing access to the ports from specific addresses.
* The **`SERVICE`** heading tells us the service's name is typically mapped to the specific port number. However, the default scan will not tell us what is listening on that port. Until we instruct **Nmap** to interact with the service and attempt to tease out identifying information, it could be another service altogether.

As we gain familiarity, we will notice that several ports are commonly associated with Windows or Linux. Let us run a more advanced **Nmap** scan and gather more information about target device.

We can use the **-`sC`** parameter to specify that **`Nmap`** scripts should be used to try and obtain more detailed information. The **-`sV`** parameter instructs **`Nmap`** to perform a version scan. The version scan is underpinned by a comprehensive database of over 1,000 services signatures. Finally, **`-p-`** tells Nmap that we want to scan all 65,535 TCP ports.

```shell-session
$ nmap -sV -sC -p- 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:18 EST
Nmap scan report for 10.129.42.253
Host is up (0.11s latency).
Not shown: 65530 closed ports
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: PHP 7.4.3 - phpinfo()
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-02-25T21:21:51
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 233.68 seconds

```

This returns a lot more information. We see that it took a lot longer to scan 65,535 ports than 1,000 ports. The **`-sC`** and **`-sV`** options also increase the duration of a scan, as instead of performing a simple TCP handshake, they perform a lot more checks. We notice that this time there is a **`VERSION`** heading, which reports the service version and the operating system, if this is possible to identify.

So far, we know that the operating system is Ubuntu Linux. Application versions can also help reveal the target OS version. Take OpenSSH, for example. We see the reported version is **`OpenSSH 8.2p1 Ubuntu 4ubuntu0.1`**. From inspection of other Ubuntu SSH package changelogs, we see the release version takes the format **`1:7.3p1-1ubuntu0.1`**. Updating our version to fit this format, we get **`1:8.2p1-4ubuntu0.1`**. A quick search for this version online reveals that it is included in Ubuntu Linux Focal Fossa 20.04. Another quick search reveals that the release date of this OS is April 23rd, 2020.

### Nmap scripts

Specifying **`-sC`** will run many useful default scripts against a target, but there are cases when running a specific script is required. For example, in an assessment scope, we may be asked to audit a large Citrix installation. We could use a **`Nmap`** script to audit for the serve Citrix NetScaler vulnerability (**CVE-2019-19781**), while Nmap also has other script to audit a Citrix installation.

The syntax for running a Nmap script is **`nmap --script <script name> -p<port> <host>`**. **`Nmap`** script are a great way to enhance our scans' functionality, and inspection of the available options will pay dividends.

## Attacking Network Services

### Banner Grabbing

As previously discussed, banner grabbing is a useful technique to fingerprint a service quickly. Often, a service will look to identify itself by displaying a banner once a connection is initialized. Nmap will attempt to grab the banners if the syntax **`nmap -sV --script=banner <target>`** is specified. We can also attempt this manually using **`Netcat`**. Let us take another example, using **`nc`** version of **`Netcat`** :&#x20;

```shell-session
$ nc -nv 10.129.42.253 21
(UNKNOWN) [10.129.42.253] 21 (ftp) open
220 (vsFTPd 3.0.3)
```

This reveals that the version of **`vsFTPd`** on the server is **`3.0.3`**. We can also automate this process using **`Nmap's`** powerful scripting engine:&#x20;

<pre class="language-shell-session"><code class="lang-shell-session"><strong>$ nmap -sV --scprit=banner -p21 10.10.10.0/24
</strong></code></pre>

### FTP (File Transfer Protocol)

A **`Nmap`** scan of the default port for FTP (21) reveals the vsftpd 3.0.3 installation that we identified previously. Further, it also reports that anonymous authentication is enabled and that a **`pub`** directory is available.

```shell-session
$ nmap -sC -sV -p21 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-20 00:54 GMT
Nmap scan report for 10.129.42.253
Host is up (0.081s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Dec 19 23:50 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
Service Info: OS: Unix

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.78 seconds

```

Let us connect to the service using the **`ftp`** command-line utility :&#x20;

```shell-session
$ ftp -p 10.129.42.253

Connected to 10.129.42.253.
220 (vsFTPd 3.0.3)
Name (10.129.42.253:user): anonymous
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

ftp> ls
227 Entering Passive Mode (10,129,42,253,158,60).
150 Here comes the directory listing.
drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
226 Directory send OK.

ftp> cd pub
250 Directory successfully changed.

ftp> ls
227 Entering Passive Mode (10,129,42,253,182,129).
150 Here comes the directory listing.
-rw-r--r--    1 ftp      ftp            18 Feb 25 19:25 login.txt
226 Directory send OK.

ftp> get login.txt
local: login.txt remote: login.txt
227 Entering Passive Mode (10,129,42,253,181,53).
150 Opening BINARY mode data connection for login.txt (18 bytes).
226 Transfer complete.
18 bytes received in 0.00 secs (165.8314 kB/s)

ftp> exit
221 Goodbye.
```

In the above shell, we see that FTP supports common commands such as **`cd`** and **`ls`** and allows us to download files using the **`get`** command. Inspection of the download **`login.txt`** reveals credentials that we could use to further our access to the system.

```shell-session
$ cat login.txt 
admin:ftp@dmin123
```

### SMB (Server Message Block)

Client-server protocol that allows access to resources via network, and particularly access to files and folders. It is a prevalent protocol on Windows machines that provides many vectors for vertical and lateral movement. Sensitive data, including credentials, can be in network file shares, and some SMB versions may be vulnerable to RCE exploits such as **`EternalBlue`**. It is crucial to enumerate this sizeable potential attack surface carefully. **`Nmap`** has many scripts for enumerating SMB, such as **`smb-os-discovery.nse`**, which will interact with the SMB service to extract the reported operating system version.

```shell-session
$ nmap --script smb-os-discovery.nse -p445 10.10.10.40

Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-27 00:59 GMT
Nmap scan report for doctors.htb (10.10.10.40)
Host is up (0.022s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: CEO-PC
|   NetBIOS computer name: CEO-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2020-12-27T00:59:46+00:00

Nmap done: 1 IP address (1 host up) scanned in 2.71 seconds
```

In this case, the host runs a legacy Windows 7 OS, and we could conduct further enumeration to confirm if it is vulnerable to **`EthernalBlue`**. We can run a scan against our target for this module section to gather information from the SMB service. We can ascertain that the host runs a Linux kernel, Samba version 4.6.2, and the hostname is GS-SVCSCAN.

```shell-session
$ nmap -A -p445 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:29 EST
Nmap scan report for 10.129.42.253
Host is up (0.11s latency).

PORT    STATE SERVICE     VERSION
445/tcp open  netbios-ssn Samba smbd 4.6.2
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 2.6.32 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Adtran 424RG FTTH gateway (92%), Linux 2.6.39 - 3.2 (92%), Linux 3.1 - 3.2 (92%), Linux 3.2 - 4.9 (92%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops

Host script results:
|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-02-25T21:30:06
|_  start_date: N/A

TRACEROUTE (using port 445/tcp)
HOP RTT       ADDRESS
1   111.62 ms 10.10.14.1
2   111.89 ms 10.129.42.253

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.72 seconds
```

### Shares

SMB allows users and administrators to share folders and make them accessible remotely by other users. Often these shares have files in them that contain sensitive information such as passwords. A tool that can enumerate and interact with SMB shares is **smbclient**. The **-L** flag specifies that we want to retrieve a list od available shares on the remote host, while -N suppresses the password prompt.

```shell-session
$ smbclient -N -L \\\\10.129.42.253

	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	users           Disk      
	IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
```

This reveals the non-default share **`users`**. Let us attempt to cannect as the guest user.

```shell-session
$ smbclient \\\\10.129.42.253\\users

Enter WORKGROUP\users's password: 
Try "help" to get a list of possible commands.

smb: \> ls
NT_STATUS_ACCESS_DENIED listing \*

smb: \> exit
```

The **`ls`** command resulted in an access denied message, indicating that guest access is not permitted. Let us try again using credentials for user bob (**`bob:Welcome1`**).

```shell-session
$ smbclient -U bob \\\\10.129.42.253\\users

Enter WORKGROUP\bob's password: 
Try "help" to get a list of possible commands.

smb: \> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 15:05:31 2021
  bob                                 D        0  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \> cd bob

smb: \bob\> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 16:42:23 2021
  passwords.txt                       N      156  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \bob\> get passwords.txt 
getting file \bob\passwords.txt of size 156 as passwords.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)
```

We successfully gained access to the **`users`** share using credentials and ganined access to the interesting file **`passwords.txt`**, which can be downloaded with the **`get`** command.

### SNMP (Simple Network Management Protocol)

An application-layer protocol that transmits management data between network devices. SNMP Comminty strings provide information and statistics about a router or device, helping us again access to it. The manufacturer default community strings of **`public`** and **`private`** are often unchanged. In SNMP version 1 and 2c, access is controlled using a plaintext community string, and if we know the name, we can gain access to it. Encryption and authentification were only added in SNMP version 3. Much information can be gained from SNMP. Examination of proccess parameters might reveal credentials passed in the command line, which might be possbile to reuse for other externally accessible services given the prevalence of password reuse in enterprise envirnoments. Routing information, services bound to additionnal interfaces, and the version of installed software can also be revealed.

```shell-session
$ snmpwalk -v 2c -c public 10.129.42.253 1.3.6.1.2.1.1.5.0

iso.3.6.1.2.1.1.5.0 = STRING: "gs-svcscan"
```

```shell-session
$ snmpwalk -v 2c -c private  10.129.42.253 

Timeout: No Response from 10.129.42.253
```

A tool such as **`onesixtyone`** can be used to brute force the community string names using a dictionary file of common community strings such as the **`dict.txt`** file included in the GitHub repo for the tool.

```shell-session
$ onesixtyone -c dict.txt 10.129.42.254

Scanning 1 hosts, 51 communities
10.129.42.254 [public] Linux gs-svcscan 5.4.0-66-generic #74-Ubuntu SMP Wed Jan 27 22:54:38 UTC 2021 x86_64
```

## Questions

Target : **`10.129.116.183`**

{% hint style="info" %}
_Perform a Nmap scan of the target. What is the version of the service from the Nmap scan running on port 8080 ?_
{% endhint %}

```shell
$ nmap -sV -sC 10.129.116.183
Starting Nmap 7.93 ( https://nmap.org ) at 2024-03-21 14:22 GMT
Nmap scan report for 10.129.116.183
Host is up (0.013s latency).
Not shown: 993 closed tcp ports (conn-refused)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Feb 25  2021 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 a001d779e9d2092ab8d9b49a6c000c1c (RSA)
|   256 2b99b21fec1a5ac6b7beb550d10ea9df (ECDSA)
|_  256 e4f8178dd471d14ed40ebdf0294f6d14 (ED25519)
80/tcp   open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: PHP 7.4.3 - phpinfo()
139/tcp  open  netbios-ssn Samba smbd 4.6.2
445/tcp  open  netbios-ssn Samba smbd 4.6.2
2323/tcp open  telnet      Linux telnetd
8080/tcp open  http        Apache Tomcat
|_http-title: Apache Tomcat
|_http-open-proxy: Proxy might be redirecting requests
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| smb2-time: 
|   date: 2024-03-21T14:22:24
|_  start_date: N/A
|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: 000000000000 (Xerox)
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.27 seconds
```

Version of the service for the port 8080 is **Apache Tomcat** (http/tcp).

{% hint style="info" %}
_Perform an Nmap scan of the target and identify the non-default port that the telnet service is running on._
{% endhint %}

```shell-session
$ nmap -sV -sC 10.129.116.183
Starting Nmap 7.93 ( https://nmap.org ) at 2024-03-21 14:22 GMT
Nmap scan report for 10.129.116.183
Host is up (0.013s latency).
Not shown: 993 closed tcp ports (conn-refused)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Feb 25  2021 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 a001d779e9d2092ab8d9b49a6c000c1c (RSA)
|   256 2b99b21fec1a5ac6b7beb550d10ea9df (ECDSA)
|_  256 e4f8178dd471d14ed40ebdf0294f6d14 (ED25519)
80/tcp   open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: PHP 7.4.3 - phpinfo()
139/tcp  open  netbios-ssn Samba smbd 4.6.2
445/tcp  open  netbios-ssn Samba smbd 4.6.2
2323/tcp open  telnet      Linux telnetd
8080/tcp open  http        Apache Tomcat
|_http-title: Apache Tomcat
|_http-open-proxy: Proxy might be redirecting requests
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| smb2-time: 
|   date: 2024-03-21T14:22:24
|_  start_date: N/A
|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: 000000000000 (Xerox)
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.27 seconds
```

The non-default port that the tenlnet service is running is **`2323`**.

{% hint style="info" %}
_List the SMB shares available on the target host. Connect to the available share as the bob user. Once connected, access the folder called 'flag' and submit the contents of the flag.txt file._
{% endhint %}

```bash
$ smbclient -N -L \\\\10.129.42.254

	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	users           Disk      
	IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
```

```bash
$ smbclient -N \\\\10.129.42.254\\users
Try "help" to get a list of possible commands.
smb: \> ls
NT_STATUS_ACCESS_DENIED listing \*
smb: \> exit
```

```bash
$ smbclient -U bob \\\\10.129.42.254\\users
Password for [WORKGROUP\bob]:
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Feb 25 23:06:52 2021
  ..                                  D        0  Thu Feb 25 20:05:31 2021
  flag                                D        0  Thu Feb 25 23:09:26 2021
  bob                                 D        0  Thu Feb 25 21:42:23 2021

		4062912 blocks of size 1024. 1284352 blocks available
smb: \> cd bob\
smb: \bob\> ls
  .                                   D        0  Thu Feb 25 21:42:23 2021
  ..                                  D        0  Thu Feb 25 23:06:52 2021
  passwords.txt                       N      156  Thu Feb 25 21:42:23 2021

		4062912 blocks of size 1024. 1284352 blocks available
smb: \bob\> get passwords.txt
getting file \bob\passwords.txt of size 156 as passwords.txt (25.4 KiloBytes/sec) (average 25.4 KiloBytes/sec)
smb: \bob\> cd ..
smb: \> ls
  .                                   D        0  Thu Feb 25 23:06:52 2021
  ..                                  D        0  Thu Feb 25 20:05:31 2021
  flag                                D        0  Thu Feb 25 23:09:26 2021
  bob                                 D        0  Thu Feb 25 21:42:23 2021

		4062912 blocks of size 1024. 1284352 blocks available
smb: \> get flag\flag.txt 
getting file \flag\flag.txt of size 33 as flag\flag.txt (4.6 KiloBytes/sec) (average 14.2 KiloBytes/sec)
smb: \> exit
```

```bash
$ cat flag\\flag.txt; sleep 5;cat passwords.txt 
dceece590f3284c3866305eb2473d099
Banking:

https://acmebank.local/login.php

bobby:Surfer1010!

Network:

bob.smith@inlanefreight.local:Welcome123!


vCenter:

root:B0b_the_m@n!-rootPa$$!
```

The contents of the flag.txt file is **`dceece590f3284c3866305eb2473d099`**.
